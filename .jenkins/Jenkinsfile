/*
* NervanaSystems/private-nlp-architect Jenkinsfile
*/

static final String nodeLabel       = 'swarm'
static final String customWorkspace = '/state/ws'

node(nodeLabel) {
    // Request a custom workspace
    //      Due to path length restrictions in virtualenv, we must request a custom
    //      workspace here instead of using the one assigned to us with the call to
    //      node(). When in a multibranch style job, Jenkins allocates a workspace
    //      with a large path length (including info like SHA, branch, time). As such
    //      virtualenv commands will fail, as virtualenv is unable to handle the long
    //      paths. See the Jenkins Docs for guarantees provided by ws():
    //      https://jenkins.io/doc/pipeline/steps/workflow-durable-task-step/#ws-allocate-workspace
    ws(customWorkspace) {
        // Clear previous workspace
        deleteDir()
        stage('Checkout') {
            // Clone repo at triggered commit
            checkout scm
        }
        stage('Build') {
            // Build using Makefile
            sh 'make'
        }
        stage('Test') {
            // Run tests using Makefile
            // TODO: Leverage Jenkins J/XUnit plugins to scan test results
            //      by exporting test results as a known J/XUnit style artifact
            sh 'make test'
        }
        stage('Style') {
            // Run style checks using Makefile
            // TODO: Leverage Jenkins Warnings plugins to scan for style errors
            //      by exporting style check results as a known artifact
            sh 'make style'
        }
        // TODO: Capture and archive any needed artifacts
        // TODO: Slack integration
    }
}
